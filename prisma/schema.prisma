// ============================================
// ERP ARTISAN - PRISMA SCHEMA (MULTI-TENANT)
// ============================================

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANCY
// ============================================

model Entreprise {
  id    String  @id @default(cuid())
  nom   String
  slug  String? @unique // URL-friendly identifier for client portal registration
  siret String? @unique
  email String  @unique

  // Gestion d'abonnement
  plan            PlanAbonnement @default(FREE)
  abonnementActif Boolean        @default(true)
  dateAbonnement  DateTime       @default(now())
  dateExpiration  DateTime?

  // Relations (toutes les données de l'entreprise)
  users            User[]
  categories       Categorie[]
  articles         Article[]
  clients          Client[]
  documents        Document[]
  mouvements       MouvementStock[]
  parametres       ParametresEntreprise?
  seriesDocuments  SerieDocument[]
  niveauxFidelite  NiveauFidelite[]
  mouvementsPoints MouvementPoints[]
  segments         Segment[]
  automations      Automation[]
  campaigns        Campaign[]
  conversations    Conversation[]
  subscription     Subscription? // Un abonnement Stripe (optionnel)
  usageCounters    UsageCounter[] // Compteurs d'usage mensuels
  paymentLinks     PaymentLink[] // Liens de paiement
  terminals        Terminal[] // Terminaux de paiement physiques
  bankTransactions BankTransaction[] // Transactions bancaires pour rapprochement

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([slug])
  @@index([siret])
  @@index([abonnementActif])
}

enum PlanAbonnement {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

// ============================================
// GESTION D'ABONNEMENTS STRIPE
// ============================================

model Subscription {
  id String @id @default(cuid())

  // Relation avec l'entreprise
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  entrepriseId String     @unique // Une entreprise = un abonnement

  // Informations Stripe
  stripeCustomerId     String  @unique
  stripeSubscriptionId String  @unique
  stripePriceId        String // Prix Stripe (monthly ou annual)
  stripeProductId      String? // Produit Stripe

  // Plan et statut
  plan   PlanAbonnement
  status SubscriptionStatus @default(ACTIVE)

  // Période de facturation
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  // Trial
  trialStart DateTime?
  trialEnd   DateTime?

  // Annulation
  cancelAtPeriodEnd Boolean   @default(false)
  canceledAt        DateTime?
  cancelReason      String?

  // Métadonnées
  metadata Json? // Données additionnelles (coupon, promo, etc.)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([entrepriseId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@index([plan])
  @@index([currentPeriodEnd])
}

enum SubscriptionStatus {
  ACTIVE // Abonnement actif
  TRIALING // En période d'essai
  PAST_DUE // Paiement en retard
  CANCELED // Annulé
  INCOMPLETE // Paiement initial incomplet
  INCOMPLETE_EXPIRED // Paiement initial expiré
  UNPAID // Impayé
  PAUSED // En pause
}

// Compteurs d'usage mensuels pour les limites
model UsageCounter {
  id String @id @default(cuid())

  // Relation avec l'entreprise
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  entrepriseId String

  // Période de comptage
  periodStart DateTime
  periodEnd   DateTime

  // Compteurs
  documentsCreated Int @default(0) // Documents créés ce mois
  questionsAsked   Int @default(0) // Questions assistant ce mois

  // Métadonnées JSON pour tracking additionnel si besoin
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([entrepriseId, periodStart]) // Un compteur par entreprise par période
  @@index([entrepriseId])
  @@index([periodStart])
  @@index([periodEnd])
}

// ============================================
// AUTHENTIFICATION
// ============================================

model User {
  id       String  @id @default(cuid())
  email    String  @unique
  password String
  name     String?
  role     String  @default("user")

  // Multi-tenant: chaque user appartient à une entreprise
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  entrepriseId String

  // Onboarding: tracking si l'utilisateur a complété son profil
  onboardingComplete Boolean @default(false)

  conversations Conversation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([entrepriseId])
  @@index([email])
}

// ============================================
// CLIENTS
// ============================================

model Client {
  id         String  @id @default(cuid())
  nom        String
  prenom     String?
  email      String?
  telephone  String?
  adresse    String?
  codePostal String?
  ville      String?
  pays       String  @default("France")
  notes      String?

  // Authentification portail client
  password        String? // Hashed password for client portal access
  clientPortalEnabled Boolean @default(false) // Enable/disable portal access
  pendingApproval Boolean @default(false) // Client waiting for admin approval after self-registration
  lastLoginAt     DateTime? // Track last portal login

  // Programme de fidélité
  points_solde     Int             @default(0)
  niveauFidelite   NiveauFidelite? @relation(fields: [niveauFideliteId], references: [id])
  niveauFideliteId String?

  // Multi-tenant
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  entrepriseId String

  documents        Document[]
  mouvementsPoints MouvementPoints[]
  notifications    ClientNotification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([entrepriseId])
  @@index([nom])
  @@index([email])
  @@index([ville])
  @@index([niveauFideliteId])
  @@index([points_solde])
  @@index([clientPortalEnabled])
  @@index([pendingApproval])
  @@index([entrepriseId, pendingApproval])
}

// Tokens de réinitialisation de mot de passe pour le portail client
model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  clientId  String
  email     String
  expiresAt DateTime
  used      Boolean  @default(false)
  usedAt    DateTime?

  createdAt DateTime @default(now())

  @@index([token])
  @@index([clientId])
  @@index([email])
  @@index([expiresAt])
}

// Tokens d'invitation pour créer un compte portail client
model InvitationToken {
  id           String   @id @default(cuid())
  token        String   @unique
  email        String
  nom          String?
  prenom       String?
  telephone    String?
  entrepriseId String
  expiresAt    DateTime
  used         Boolean  @default(false)
  usedAt       DateTime?

  createdAt DateTime @default(now())

  @@index([token])
  @@index([email])
  @@index([entrepriseId])
  @@index([expiresAt])
}

// Notifications pour le portail client
model ClientNotification {
  id       String               @id @default(cuid())
  type     NotificationType
  titre    String
  message  String?
  lue      Boolean              @default(false)
  metadata Json?                // Données additionnelles (documentId, points, etc.)

  client   Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId String

  createdAt DateTime @default(now())
  lueAt     DateTime?

  @@index([clientId])
  @@index([lue])
  @@index([createdAt])
  @@index([clientId, lue])
}

enum NotificationType {
  NOUVEAU_DOCUMENT
  POINTS_EXPIRATION
  NIVEAU_FIDELITE
  PAIEMENT_RECU
  GENERAL
}

// ============================================
// CATALOGUE
// ============================================

model Categorie {
  id          String  @id @default(cuid())
  nom         String
  description String?
  ordre       Int     @default(0)
  parentId    String?

  // Multi-tenant
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  entrepriseId String

  parent       Categorie?          @relation("CategoriesToParent", fields: [parentId], references: [id])
  enfants      Categorie[]         @relation("CategoriesToParent")
  articles     Article[]
  champsCustom ChampPersonnalise[]

  createdAt DateTime @default(now())

  @@index([entrepriseId])
  @@index([nom])
  @@index([ordre])
}

model ChampPersonnalise {
  id          String          @id @default(cuid())
  categorieId String
  nom         String
  code        String
  type        TypeChampCustom @default(TEXT)
  ordre       Int             @default(0)
  obligatoire Boolean         @default(false)
  placeholder String?
  description String?
  options     Json?
  validation  Json?

  categorie Categorie @relation(fields: [categorieId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([categorieId, code])
  @@index([categorieId])
  @@index([ordre])
}

enum TypeChampCustom {
  TEXT
  TEXTAREA
  NUMBER
  DECIMAL
  SELECT
  MULTISELECT
  CHECKBOX
  DATE
  COLOR
  URL
  EMAIL
}

model Article {
  id            String      @id @default(cuid())
  reference     String
  nom           String
  description   String?
  type          ArticleType @default(PRODUIT)
  prix_ht       Decimal     @db.Decimal(10, 2)
  tva_taux      Decimal     @default(20.00) @db.Decimal(5, 2)
  unite         String      @default("unité")
  stock_actuel  Int         @default(0)
  stock_min     Int         @default(0)
  gestion_stock Boolean     @default(false)
  actif         Boolean     @default(true)
  champsCustom  Json?

  // Multi-tenant
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  entrepriseId String

  categorie   Categorie?       @relation(fields: [categorieId], references: [id])
  categorieId String?
  lignes      LigneDocument[]
  mouvements  MouvementStock[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([entrepriseId, reference])
  @@index([entrepriseId])
  @@index([reference])
  @@index([nom])
  @@index([type])
  @@index([categorieId])
  @@index([actif])
}

enum ArticleType {
  PRODUIT
  SERVICE
}

// ============================================
// TRANSACTIONS
// ============================================

model Document {
  id           String         @id @default(cuid())
  numero       String
  type         DocumentType
  dateEmission DateTime       @db.Date
  dateEcheance DateTime?      @db.Date
  statut       DocumentStatut @default(BROUILLON)

  // Multi-tenant
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  entrepriseId String

  client   Client @relation(fields: [clientId], references: [id])
  clientId String

  // Série de numérotation (optionnel pour rétrocompatibilité)
  serie   SerieDocument? @relation(fields: [serieId], references: [id])
  serieId String?

  total_ht  Decimal @default(0) @db.Decimal(10, 2)
  total_tva Decimal @default(0) @db.Decimal(10, 2)
  total_ttc Decimal @default(0) @db.Decimal(10, 2)

  acompte_montant Decimal @default(0) @db.Decimal(10, 2)
  reste_a_payer   Decimal @default(0) @db.Decimal(10, 2)

  notes               String?
  conditions_paiement String?
  validite_jours      Int     @default(30)

  devisId  String?
  devis    Document?  @relation("DevisToFacture", fields: [devisId], references: [id])
  factures Document[] @relation("DevisToFacture")

  lignes    LigneDocument[]
  paiements Paiement[]
  bankTransactions BankTransaction[] // Transactions bancaires rapprochées

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([entrepriseId, numero])
  @@index([entrepriseId])
  @@index([numero])
  @@index([type])
  @@index([clientId])
  @@index([serieId])
  @@index([statut])
  @@index([dateEmission])
  @@index([dateEcheance])
}

enum DocumentType {
  DEVIS
  FACTURE
  AVOIR
}

enum DocumentStatut {
  BROUILLON
  ENVOYE
  ACCEPTE
  REFUSE
  PAYE
  ANNULE
}

model LigneDocument {
  id         String   @id @default(cuid())
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId String
  article    Article? @relation(fields: [articleId], references: [id])
  articleId  String?

  ordre            Int
  designation      String
  description      String?
  quantite         Decimal @db.Decimal(10, 2)
  prix_unitaire_ht Decimal @db.Decimal(10, 2)
  tva_taux         Decimal @db.Decimal(5, 2)
  remise_pourcent  Decimal @default(0) @db.Decimal(5, 2)

  montant_ht  Decimal @db.Decimal(10, 2)
  montant_tva Decimal @db.Decimal(10, 2)
  montant_ttc Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  @@index([documentId])
  @@index([articleId])
  @@index([ordre])
}

model Paiement {
  id             String        @id @default(cuid())
  document       Document      @relation(fields: [documentId], references: [id], onDelete: Restrict)
  documentId     String
  date_paiement  DateTime      @db.Date
  montant        Decimal       @db.Decimal(10, 2)
  moyen_paiement MoyenPaiement
  reference      String?
  notes          String?

  createdAt DateTime @default(now())

  @@index([documentId])
  @@index([date_paiement])
  @@index([moyen_paiement])
}

enum MoyenPaiement {
  ESPECES
  CHEQUE
  VIREMENT
  CARTE
  PRELEVEMENT
}

// ============================================
// GESTION DES STOCKS
// ============================================

model MouvementStock {
  id          String        @id @default(cuid())
  type        TypeMouvement
  quantite    Int
  stock_avant Int
  stock_apres Int
  motif       String?
  reference   String?
  notes       String?

  // Multi-tenant
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  entrepriseId String

  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  articleId String

  createdAt DateTime @default(now())
  createdBy String?

  @@index([entrepriseId])
  @@index([articleId])
  @@index([type])
  @@index([createdAt])
}

enum TypeMouvement {
  ENTREE
  SORTIE
  AJUSTEMENT
  INVENTAIRE
  RETOUR
}

// ============================================
// PARAMÈTRES ENTREPRISE
// ============================================

model ParametresEntreprise {
  id             String  @id @default(cuid())
  nom_entreprise String
  siret          String?
  tva_intra      String?
  adresse        String?
  code_postal    String?
  ville          String?
  telephone      String?
  email          String?
  site_web       String?
  logo_url       String?

  prefixe_devis           String @default("DEV")
  prefixe_facture         String @default("FACT")
  prochain_numero_devis   Int    @default(1)
  prochain_numero_facture Int    @default(1)

  // Configuration références articles/services
  prefixe_produit         String @default("PRD")
  prefixe_service         String @default("SRV")
  prochain_numero_produit Int    @default(1)
  prochain_numero_service Int    @default(1)

  conditions_paiement_defaut String?
  mentions_legales           String?

  // Multi-tenant: relation one-to-one
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  entrepriseId String     @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([entrepriseId])
}

// Séries de numérotation personnalisées pour les documents
model SerieDocument {
  id          String  @id @default(cuid())
  code        String // "ART", "SER", "CONS", etc.
  nom         String // "Vente de produits", "Prestations", etc.
  description String?
  couleur     String? @default("#000000") // Couleur pour l'UI

  // Types de documents supportés par cette série
  pour_devis    Boolean @default(true)
  pour_factures Boolean @default(true)
  pour_avoirs   Boolean @default(false)

  // Numérotation indépendante
  prochain_numero Int       @default(1)
  format_numero   String    @default("{CODE}{NUM5}") // Variables: {CODE}, {NUM5}, {YEAR}, {MONTH}, {TYPE}
  reset_compteur  String    @default("AUCUN") // "AUCUN", "ANNUEL", "MENSUEL"
  derniere_reset  DateTime? // Date du dernier reset (pour tracking)

  // Configuration - Séries par défaut par type
  est_defaut_devis    Boolean @default(false) // Série par défaut pour les devis
  est_defaut_factures Boolean @default(false) // Série par défaut pour les factures
  est_defaut_avoirs   Boolean @default(false) // Série par défaut pour les avoirs
  active              Boolean @default(true)

  // Multi-tenant
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  entrepriseId String

  // Relations
  documents Document[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([entrepriseId, code])
  @@index([entrepriseId])
  @@index([entrepriseId, est_defaut_devis])
  @@index([entrepriseId, est_defaut_factures])
  @@index([entrepriseId, est_defaut_avoirs])
  @@index([active])
}

// ============================================
// PROGRAMME DE FIDÉLITÉ
// ============================================

model NiveauFidelite {
  id          String  @id @default(cuid())
  nom         String
  description String?
  ordre       Int     @default(0)
  seuilPoints Int
  remise      Decimal @default(0) @db.Decimal(5, 2)
  couleur     String  @default("#000000")
  icone       String?
  avantages   String?
  actif       Boolean @default(true)

  // Multi-tenant
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  entrepriseId String

  clients Client[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([entrepriseId, nom])
  @@unique([entrepriseId, ordre])
  @@index([entrepriseId])
  @@index([ordre])
  @@index([seuilPoints])
  @@index([actif])
}

model MouvementPoints {
  id             String              @id @default(cuid())
  type           TypeMouvementPoints
  points         Int
  description    String?
  reference      String?
  dateExpiration DateTime?           @db.Date

  // Multi-tenant
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  entrepriseId String

  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId String

  createdAt DateTime @default(now())

  @@index([entrepriseId])
  @@index([clientId])
  @@index([type])
  @@index([createdAt])
  @@index([dateExpiration])
}

enum TypeMouvementPoints {
  GAIN
  DEPENSE
  EXPIRATION
  AJUSTEMENT
}

// ============================================
// SEGMENTATION CLIENTS
// ============================================

model Segment {
  id          String      @id @default(cuid())
  nom         String
  description String?
  type        TypeSegment @default(CUSTOM)
  icone       String? // Nom de l'icône lucide-react (ex: "Users", "Mail", "MapPin")
  couleur     String? // Couleur de fond (ex: "#f3f4f6")

  // Critères de filtrage stockés en JSON
  // Format pour segments prédéfinis: { type: "all" } ou { type: "with-email" }
  // Format pour segments custom: [
  //   { field: "email", operator: "exists" },
  //   { field: "points_solde", operator: "gt", value: 100 }
  // ]
  criteres Json

  // Statistiques (cache, recalculées périodiquement)
  derniereCalcul DateTime?
  nombreClients  Int?      @default(0)

  // Multi-tenant
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  entrepriseId String

  campaigns Campaign[]

  actif     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([entrepriseId, nom])
  @@index([entrepriseId])
  @@index([type])
  @@index([actif])
}

enum TypeSegment {
  PREDEFINED // Segments système (tous clients, avec email, etc.)
  CUSTOM // Segments créés par l'utilisateur
}

// ============================================
// AUTOMATIONS
// ============================================

model Automation {
  id          String  @id @default(cuid())
  nom         String
  description String?
  actif       Boolean @default(true)

  // Trigger
  triggerType   TriggerType
  triggerConfig Json // Configuration du trigger

  // Action
  actionType   ActionType
  actionConfig Json // Configuration de l'action

  // Statistiques
  derniereExecution DateTime?
  nombreExecutions  Int       @default(0)

  // Multi-tenant
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  entrepriseId String

  executions AutomationExecution[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([entrepriseId])
  @@index([actif])
  @@index([triggerType])
}

enum TriggerType {
  NEW_CLIENT_IN_SEGMENT
  CLIENT_MILESTONE
  SEGMENT_CHANGE
  INACTIVITY
  SCHEDULED
}

enum ActionType {
  SEND_EMAIL
  ADD_TO_SEGMENT
  REMOVE_FROM_SEGMENT
  ADD_POINTS
  SEND_SMS
  CREATE_TASK
}

model AutomationExecution {
  id           String     @id @default(cuid())
  automation   Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  automationId String

  clientId String?
  statut   ExecutionStatut
  resultat String?
  erreur   String?

  executedAt DateTime @default(now())

  @@index([automationId])
  @@index([statut])
  @@index([executedAt])
}

enum ExecutionStatut {
  SUCCESS
  FAILED
  PENDING
}

// ============================================
// CAMPAGNES
// ============================================

model Campaign {
  id          String         @id @default(cuid())
  nom         String
  description String?
  type        CampaignType   @default(EMAIL)
  statut      CampaignStatut @default(DRAFT)

  segment   Segment? @relation(fields: [segmentId], references: [id])
  segmentId String?
  subject   String?
  body      String?

  scheduledAt DateTime?
  sentAt      DateTime?

  recipientsCount Int @default(0)
  sentCount       Int @default(0)
  openedCount     Int @default(0)
  clickedCount    Int @default(0)

  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  entrepriseId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([entrepriseId])
  @@index([statut])
  @@index([scheduledAt])
}

enum CampaignType {
  EMAIL
  SMS
  NOTIFICATION
}

enum CampaignStatut {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  CANCELLED
}

// ============================================
// CHATBOT IA
// ============================================

model Conversation {
  id     String  @id @default(cuid())
  titre  String // Auto-généré à partir du premier message
  pinned Boolean @default(false) // Conversations épinglées

  // Multi-tenant
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  entrepriseId String

  messages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([entrepriseId])
  @@index([createdAt])
  @@index([pinned])
}

model Message {
  id             String       @id @default(cuid())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String

  role    MessageRole // "user" | "assistant" | "system"
  content String      @db.Text

  // Tracking du modèle IA utilisé (pour analytics)
  model String? // "gpt-4o-mini" | "gpt-4o" | null (si user message)

  // Métadonnées JSON pour:
  // - Actions exécutées (function calling results)
  // - Feedback utilisateur (thumbs up/down)
  // - Tokens utilisés (input/output)
  // - Temps de réponse
  metadata Json?

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([role])
  @@index([createdAt])
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// ============================================
// LIENS DE PAIEMENT (PAYMENT LINKS)
// ============================================

model PaymentLink {
  id          String  @id @default(cuid())
  slug        String  @unique // URL-friendly slug (ex: "facture-mars-2025")
  titre       String // Titre du lien (ex: "Facture Mars 2025")
  description String? // Description optionnelle

  montant     Decimal @db.Decimal(10, 2)
  devise      String  @default("EUR")

  // Options
  quantiteMax     Int?      @default(1) // Nombre de paiements max (null = illimité)
  quantitePaye    Int       @default(0) // Nombre de paiements effectués
  dateExpiration  DateTime? // Date d'expiration du lien
  actif           Boolean   @default(true)

  // Personnalisation
  imageCouverture String? // URL de l'image de couverture
  messageSucces   String? // Message affiché après paiement

  // Métadonnées
  metadata Json? // Données additionnelles (référence commande, etc.)

  // Multi-tenant
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  entrepriseId String

  // Statistiques
  nombreVues      Int @default(0) // Nombre de fois que le lien a été consulté
  nombrePaiements Int @default(0) // Nombre de paiements réussis
  totalCollecte   Decimal @default(0) @db.Decimal(10, 2) // Montant total collecté

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([entrepriseId])
  @@index([slug])
  @@index([actif])
  @@index([dateExpiration])
}

enum PaymentLinkStatus {
  ACTIVE
  EXPIRED
  COMPLETED
  DISABLED
}

// ============================================
// STRIPE TERMINAL (TPE PHYSIQUES)
// ============================================

model Terminal {
  id              String         @id @default(cuid())
  stripeTerminalId String        @unique // ID du terminal dans Stripe
  label           String // Nom du terminal (ex: "Caisse 1")
  location        String? // Emplacement physique
  status          TerminalStatus @default(OFFLINE)

  // Informations matériel
  device_type     String? // Type de terminal (bbpos_wisepad3, verifone_p400, etc.)
  serial_number   String?
  ip_address      String?

  // Multi-tenant
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  entrepriseId String

  // Dernière activité
  lastUsedAt   DateTime?
  lastSyncAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([entrepriseId])
  @@index([status])
  @@index([stripeTerminalId])
}

enum TerminalStatus {
  ONLINE
  OFFLINE
  BUSY
  ERROR
}

// ============================================
// RAPPROCHEMENT BANCAIRE
// ============================================

model BankTransaction {
  id             String    @id @default(cuid())

  // Informations transaction bancaire
  date           DateTime  @db.Date
  libelle        String // Libellé de la transaction
  montant        Decimal   @db.Decimal(10, 2)
  reference      String? // Référence bancaire

  // Rapprochement
  statut         ReconciliationStatus @default(PENDING)
  documentId     String? // Document associé (si trouvé)
  document       Document? @relation(fields: [documentId], references: [id])

  // Notes et métadonnées
  notes          String?
  metadata       Json? // Infos additionnelles du relevé bancaire

  // Multi-tenant
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  entrepriseId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([entrepriseId])
  @@index([statut])
  @@index([date])
  @@index([documentId])
}

enum ReconciliationStatus {
  PENDING // En attente de rapprochement
  MATCHED // Rapproché automatiquement
  MANUAL // Rapproché manuellement
  IGNORED // Ignoré
  ANOMALY // Anomalie détectée
}
